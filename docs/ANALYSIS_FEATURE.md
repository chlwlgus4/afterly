# Afterly - 분석 기능 상세 문서

## 개요

Afterly의 분석 기능은 Before/After 이미지를 **on-device(기기 내)에서** 비교 분석합니다.
외부 서버 전송 없이 Dart `image` 패키지와 `Isolate`를 활용하여 프라이버시를 보장합니다.

---

## 분석 항목

### 1. 얼굴 라인 변화 (Jawline Score)

**목적**: 턱 라인(얼굴 하단 1/3) 영역의 변화 정도를 수치화

**알고리즘**:
1. Before/After 이미지를 200x200으로 리사이즈
2. 이미지 하단 35% 영역(y=65%~100%)을 턱 라인 영역으로 설정
3. 각 픽셀을 그레이스케일 변환: `Gray = R×0.299 + G×0.587 + B×0.114`
4. Before/After 같은 좌표의 그레이스케일 차이 절대값 계산
5. 전체 픽셀 평균 차이 → 점수 변환: `(평균차이 / 50 × 100)`, 0~100 범위

**해석**:
- 70점 이상: 뚜렷한 변화 감지
- 40~69점: 미세한 변화
- 40점 미만: 변화 크지 않음

### 2. 좌우 균형 (Symmetry Score)

**목적**: 얼굴 좌우 대칭 개선도 측정

**알고리즘**:
1. 이미지를 좌/우 반으로 나눔
2. 좌측 픽셀과 우측 대칭 픽셀의 밝기 차이 평균 계산
3. Before의 비대칭도와 After의 비대칭도를 각각 계산
4. 개선도 = Before 비대칭 - After 비대칭
5. 점수: `50 + (개선도 × 10)`, 0~100 범위

**해석**:
- 70점 이상: 좌우 균형 크게 개선
- 40~69점: 균형 유지
- 40점 미만: 차이 크지 않음

### 3. 피부 톤 균일도 (Skin Tone Score)

**목적**: 피부 톤의 균일성 변화 측정

**알고리즘**:
1. 이미지 중앙 영역(x=25%~75%, y=20%~80%) 추출
2. 2픽셀 간격으로 샘플링하여 그레이스케일 값 수집
3. 분산(variance) 계산: 값이 낮을수록 톤이 균일
4. Before/After 분산 차이로 개선도 산출
5. 점수: `50 + (개선도 × 5)`, 0~100 범위

**해석**:
- 70점 이상: 피부 톤 균일도 크게 향상
- 40~69점: 변화 감지
- 40점 미만: 변화 크지 않음

---

## 분석 요약 생성

3개 점수를 기반으로 자동으로 한국어 요약문을 생성합니다:

```
예시:
- "관리 후 턱 라인에서 뚜렷한 변화가 관찰되었습니다, 좌우 균형이 개선되었습니다."
- "관리 후 피부 톤 균일도가 향상되었습니다."
- "관리 전후 비교 분석이 완료되었습니다." (모든 점수 40 미만)
```

---

## Heatmap (변화 시각화)

Before/After 이미지의 픽셀별 차이를 색상으로 시각화합니다.

**알고리즘**:
1. 두 이미지를 256x256으로 리사이즈
2. 각 픽셀의 RGB 채널별 차이 평균 계산
3. 차이값 × 3으로 강도(intensity) 산출
4. 색상 매핑:
   - 0~127 (변화 적음): 파란색 → 초록색
   - 128~255 (변화 큼): 초록색 → 빨간색
5. PNG로 저장, 비교 화면에서 50% 투명도로 오버레이

---

## 기술 구현

### Isolate 처리

이미지 디코딩과 픽셀 분석은 **CPU 집약적 작업**이므로 `Isolate.run()`으로 별도 스레드에서 실행합니다.

```dart
// 메인 스레드 블로킹 방지
final result = await Isolate.run(() {
  return _analyzeInIsolate(beforeBytes, afterBytes);
});
```

### 이미지 처리

```dart
// 직접 디코드 + 리사이즈 (img.Command 파이프라인 대신)
final beforeRaw = img.decodeImage(beforeBytes);
final beforeImg = img.copyResize(beforeRaw, width: 200, height: 200);
```

- `img.decodeImage()`: JPEG/PNG 바이트를 Image 객체로 디코딩
- `img.copyResize()`: 200x200 썸네일로 리사이즈 (성능 최적화)
- 원본 해상도(4000x3000 등)를 직접 분석하면 수십 초 소요 → 200x200으로 약 5~10초

### 처리 시간

| 단계 | 예상 시간 |
|------|-----------|
| 파일 읽기 | ~0.5초 |
| Isolate 생성 | ~0.3초 |
| 이미지 디코딩 (200x200) | ~2초 |
| 픽셀 분석 (3개 항목) | ~2초 |
| DB 저장 | ~0.1초 |
| **총합** | **약 5~10초** |

---

## 분석 결과 화면 UI

### 점수 표시
- 원형 프로그래스 인디케이터 (0~100)
- 색상: 70+ 초록(success), 40~69 주황(warning), 0~39 빨강(error)

### 분석 흐름
```
비교 화면 → [분석하기] 버튼 클릭
  → 프로그래스바 + 경과 시간 표시
  → Isolate에서 분석 수행
  → DB에 결과 저장
  → 분석 결과 화면으로 자동 이동
```

---

## 제한 사항 & 향후 개선

### 현재 제한
- **on-device 분석**: AI/ML 모델 없이 픽셀 비교 방식으로 정밀도 한계
- **조명 영향**: 동일 조명이 아니면 피부 톤 점수가 부정확할 수 있음
- **고정 영역**: 턱 라인 영역이 이미지 하단 35%로 고정 (얼굴 위치에 따라 부정확)
- **200x200 해상도**: 미세한 차이는 리사이즈 시 손실

### 향후 개선 가능
- ML Kit Face Mesh로 얼굴 랜드마크 기반 영역 추출
- 얼굴 영역만 크롭하여 분석 (배경 제외)
- GPU 가속 이미지 처리
- 서버 기반 AI 분석 (선택적 클라우드 업로드)
- 시계열 분석 (여러 세션의 변화 추적 그래프)
